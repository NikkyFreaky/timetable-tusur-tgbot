# Telegram Bot для расписания ТУСУР

Бот для автоматической отправки расписания занятий в Telegram чаты.

## Основные возможности

- Автоматическая отправка расписания в указанные чаты
- Поддержка тем (топиков) в форумах
- Управление через команды и интерактивные кнопки
- Хранение настроек в Cloudflare KV

## Команды бота

- `/start` - Инициализация бота в чате
- `/settings` - Настройки бота
- `/help` - Справка по командам
- `/status` - Показать текущий статус
- `/seturl <URL>` - Изменить URL расписания
- `/setthread` - Установить тему для отправки (команда должна быть отправлена в нужной теме)

## Настройки

В настройках отображается:
- **Название чата** - автоматически определяется из Telegram
- **Статус** - включен/выключен
- **Группа** - выбранная группа для расписания
- **Тема (thread)** - название и ID темы для отправки сообщений

### Выбор группы

Группу можно выбрать через интерактивное меню в три шага:

1. **Выберите факультет** - список всех факультетов ТУСУР
2. **Выберите курс** - 1, 2, 3 или 4 курс
3. **Выберите группу** - конкретная группа на выбранном курсе

После выбора группы URL расписания автоматически обновится.

### Выбор темы

Для выбора темы доступны два способа:

1. **Через интерактивное меню** - нажмите "Настроить тему" в настройках, и выберите нужную тему из списка
2. **Через команду** - отправьте `/setthread` в нужной теме чата

Список доступных тем формируется автоматически по мере получения сообщений в разных темах форума.

## Развертывание

Бот развернут на Cloudflare Workers и использует:
- Cloudflare Workers для обработки запросов
- Cloudflare KV для хранения настроек
- Cloudflare Cron Triggers для автоматической отправки расписания

## Структура проекта

```
src/
├── config/              # Конфигурация и константы
│   ├── constants.js     # Константы приложения
│   └── messages.js      # Текстовые сообщения бота
├── handlers/            # Обработчики команд и событий
│   ├── callbackHandlers.js   # Обработка callback query
│   ├── commandHandlers.js    # Обработка команд бота
│   └── updateHandler.js      # Главный обработчик обновлений
├── parsers/             # Парсеры данных с сайта ТУСУР
│   ├── coursesParser.js      # Парсинг курсов факультета
│   ├── facultiesParser.js    # Парсинг списка факультетов
│   ├── groupsParser.js       # Парсинг групп
│   └── timetableParser.js    # Парсинг расписания
├── services/            # Бизнес-логика и сервисы
│   ├── cacheService.js       # Кэширование данных
│   └── settingsService.js    # Управление настройками чатов
├── utils/               # Вспомогательные утилиты
│   ├── formatter.js          # Форматирование сообщений
│   ├── htmlUtils.js          # Утилиты для работы с HTML
│   ├── keyboards.js          # Создание inline клавиатур
│   └── telegramApi.js        # Работа с Telegram Bot API
└── worker.js            # Точка входа Cloudflare Worker
```

## Архитектура

### Разделение ответственности

- **config/** - Все константы, настройки и текстовые сообщения вынесены в отдельные файлы для удобства изменения
- **handlers/** - Обработчики команд и событий от Telegram, разделены по типам (команды, callback query)
- **parsers/** - Каждый парсер отвечает за свою область: факультеты, курсы, группы, расписание
- **services/** - Бизнес-логика: кэширование данных и управление настройками чатов
- **utils/** - Вспомогательные функции: форматирование, работа с Telegram API, создание клавиатур

### Основные принципы

- Модульность: каждый файл отвечает за конкретную функциональность
- Переиспользование: общие утилиты вынесены в отдельные модули
- Читаемость: текстовые сообщения и константы вынесены в конфигурацию
- Масштабируемость: легко добавлять новые команды, парсеры или функциональность

