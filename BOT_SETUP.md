# Настройка тестового бота

## Создание тестового бота

### Шаг 1: Создание бота через @BotFather

1. Откройте @BotFather в Telegram
2. Нажмите `/newbot`
3. Введите имя бота, например:
   - `TUSUR Test Bot`
   - `test_tusur_schedule_bot`
4. Выберете пользователя (`@username`) в качестве разработчика
5. Получите `BOT_TOKEN` (сохраните его в безопасном месте!)
6. Получите `WEBHOOK_URL` после деплоя:
   ```
   https://timetable-tusur-tgbot.vercel.app/api/telegram/webhook
   ```

### Шаг 2: Настройка бота

1. Создайте групповой чат для теста (НЕ канал!):
   - Тип: "Групповой чат"
   - Имя: "Тест расписание"
   - Добавьте бота в чат

2. Пригласите 1-2 друзей для теста:
   - Они должны быть добавлены в чат
   - Это поможет тестировать права доступа

## Настройка webhook для тестового бота

### Используйте команду curl:

```bash
# Проверка текущего webhook
curl "https://api.telegram.org/bot<YOUR_TEST_BOT_TOKEN>/getWebhookInfo"

# Установка webhook
curl -X POST "https://api.telegram.org/bot<YOUR_TEST_BOT_TOKEN>/setWebhook" \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://timetable-tusur-tgbot.vercel.app/api/telegram/webhook"
  }'
```

### Проверка webhook:

```bash
curl "https://api.telegram.org/bot<YOUR_TEST_BOT_TOKEN>/getWebhookInfo"
```

Должен вернуть:
```json
{
  "ok": true,
  "result": {
    "url": "https://timetable-tusur-tgbot.vercel.app/api/telegram/webhook",
    ...
  }
}
```

## Создание тестового группового чата

### Шаг 1: Создайте обычную группу

1. Откройте Telegram
2. Создайте новую группу:
   - Название: "Тест расписание"
   - Тип: Групповой чат (НЕ канал!)
   - Доступ: Только для участников
3. Добавьте всех тестовых пользователей

### Шаг 2: Добавьте тестового бота

1. Откройте группу
2. Добавьте `TUSUR Test Bot`
3. Убедитесь, что:
   - Бот имеет права администратора
   - Все участники могут писать

## Создание тестового форума с темами

### Шаг 1: Создайте форум

1. Создайте группу
2. Нажмите на "Информация о чате"
3. Нажмите "Тип чата" → "Форум"
4. Включите "Темы"
5. Создайте темы:
   - "Расписание" - для уведомлений
   - "Обсуждения" - для общения
   - "Объявления" - для важной инфо
6. Убедитесь, что включены inline кнопки

### Шаг 2: Добавьте тестового бота в форум

1. Добавьте `TUSUR Test Bot`
2. Убедитесь, что бот может:
   - Создавать темы
   - Отправлять уведомления
   - Работать с темами

## Тестирование

### Тест 1: Добавление бота в обычную группу

1. Добавьте бота в созданную группу
2. Ожидайте сообщение: "Перейдите в личные сообщения бота и откройте веб-приложение для настройки уведомлений группы."
3. Проверьте, что:
   - Сообщение пришло в группе
   - Нет кнопки с веб-приложением
   - Текст корректный

### Тест 2: Открытие веб-приложения из личного чата

1. Откройте личный чат с ботом
2. Нажмите кнопку "Открыть расписание" (должна быть)
3. Проверьте, что открылось веб-приложение
4. Проверьте, что отображаются вкладки "Расписание" и "Группы"
5. Проверьте, что ваш тестовый бот находится в списке групп

### Тест 3: Настройка группы из личного чата

1. Перейдите во вкладку "Группы"
2. Выберите тестовую группу из списка
3. Настройте расписание:
   - Выбор группы
   - Выбор темы (если это форум)
   - Включение уведомлений
   - Время отправки
   - Типы уведомлений
4. Проверьте автоматическое сохранение настроек

### Тест 4: Открытие веб-приложения из группы

1. Откройте веб-приложение из группового чата
2. Проверьте, что отображается сообщение:
   ```
   Настройки чата: {название чата}

   Настройки доступны через личные сообщения бота. Откройте веб-приложение из личных сообщений бота и перейдите в раздел "Группы".
   ```
3. Проверьте, что есть кнопка "Открыть настройки"
4. Нажмите и проверьте, что открывается панель настроек

### Тест 5: Создание форума с темами

1. Создайте форум
2. Добавьте бота в форум
3. Откройте веб-приложение из форума
4. Выберите форум в списке групп
5. Проверьте, что:
   - Отображается опция выбора темы
   - Список тем загружен корректно
   - Тема "Основной чат" всегда доступна

### Тест 6: Настройка форума

1. Выберите тестовую тему для уведомлений
2. Настройте расписание для форума
3. Проверьте автоматическое сохранение

### Тест 7: Права доступа

**Сценарий 1: Неадминистратор открывает настройки**
1. Добавьте пользователя в группу (не админ!)
2. Попросите его открыть веб-приложение группы
3. Он должен увидеть:
   ```
   Недостаточно прав
   У вас нет прав администратора в этой группе. Настройку расписания могут выполнять только администраторы.
   ```

**Сценарий 2: Администратор изменяет настройки**
1. Измените группу расписания
2. Добавьте бота в другую группу
3. Проверьте, что настройки сохраняются
4. Проверьте, что другие пользователи видят обновленные настройки

## Устранение webhook

После завершения тестов:

```bash
# Удаление webhook
curl -X POST "https://api.telegram.org/bot<YOUR_TEST_BOT_TOKEN>/deleteWebhook"
```

## Проверка базы данных

Используйте SQL Editor в Supabase Dashboard:

```sql
-- Проверка всех чатов
SELECT id, title, topic_id, is_forum, created_by
FROM chats
ORDER BY created_at DESC;

-- Проверка участников чатов
SELECT cm.chat_id, cm.role, u.first_name, u.last_name
FROM chat_members cm
LEFT JOIN users u ON cm.user_id = u.id
ORDER BY cm.created_at DESC;

-- Проверка тем
SELECT * FROM chat_topics
ORDER BY created_at DESC;
```

## Проверка логов Vercel

1. Откройте Vercel Dashboard → Logs
2. Фильтр по `path: /api/telegram/webhook`
3. Проверьте, что запросы от Telegram проходят без ошибок
4. Проверьте логи:
   ```
   [Telegram sendMessage] Request body: {...}
   [Telegram sendMessage] Success
   ```
5. Искайте ошибки:
   - `Failed to load chat settings`
   - `Failed to update settings`
   - `Failed to update topic`

---

## После завершения тестирования

Когда все тесты пройдены:

1. ✅ Закоммить изменения в ветку `issues-2`
2. ✅ Создать Pull Request в `master`
3. ✅ Опишите все протестированные сценарии в PR

4. После мержа в `master`:
   - Удалите тестового бота через @BotFather
   - Удалите тестовые чаты
   - Очистите тестовые данные из Supabase
